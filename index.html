<!doctype html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=yes">
<title>Nursing Prometric Test Portal â€” Android Optimized</title>
<style>
  /* Basic layout (keeps original styling) */
  body{font-family:Arial; text-align:center; background:#eef5f5; margin:0; padding:0}
  .landing { padding:14px; }
  .landing img{ width:100%; max-height:45vh; object-fit:cover; }
  .button{ display:inline-block; padding:12px 20px; margin:8px; background:#007b83; color:#fff; border-radius:10px; border:none; cursor:pointer; min-width:130px; text-decoration:none; font-size:16px; }
  .button:hover{ background:#005f63; }

  /* Android-optimized quiz layout */
  .quiz-wrap{ padding:14px; box-sizing:border-box; max-width:820px; margin:0 auto; }
  .question-box{ background:#fff; padding:18px; border-radius:14px; box-shadow:0 6px 20px rgba(0,0,0,0.12); font-size:1.6rem; margin-bottom:18px; min-height:110px; text-align:left; line-height:1.35; word-break:break-word; }
  .options-box{ background:#fff; padding:18px; border-radius:14px; box-shadow:0 6px 20px rgba(0,0,0,0.12); font-size:1.5rem; }
  .option{ display:block; width:100%; text-align:left; padding:16px; margin:10px 0; border-radius:12px; border:2px solid #007b83; background:#e6f8f9; font-size:1.5rem; cursor:pointer; }
  .option:active{ background:#c7eef0; }
  .small{ font-size:0.95rem; color:#333; }

  /* Login / dashboard */
  .card{ background:#fff; padding:16px; margin:14px auto; border-radius:12px; max-width:540px; box-shadow:0 6px 18px rgba(0,0,0,0.08); text-align:left; }
  input[type="text"], input[type="password"]{ width:100%; padding:12px; margin:8px 0; border-radius:8px; border:1px solid #ddd; font-size:16px; box-sizing:border-box; }

  /* Responsive tweaks */
  @media (max-width:480px){
    .question-box{ font-size:1.9rem; min-height:140px; }
    .options-box{ font-size:1.8rem; }
    .option{ padding:18px; font-size:1.8rem; margin:12px 0; }
  }
</style>
</head>
<body>

<!-- Landing -->
<div class="landing">
  <img src="https://raw.githubusercontent.com/gyoutrain-lab/prometric-nursing-test-demo/main/icon17%20(1).jpg" alt="Nursing Prometric Demo" />
  <h1>Welcome to Nursing Prometric Simulation Test</h1>
  <p class="small">Try the demo first or continue to the full 500-item test to master your skills!</p>

  <a class="button" href="https://gyoutrain-lab.github.io/prometric-nursing-test-demo/" target="_blank">ðŸ©º Open Demo Test</a>
  <button class="button" id="continueBtn">ðŸ”‘ Continue Full Test</button>
</div>

<!-- Dashboard / Login container (dynamically rendered) -->
<div id="dashboard" style="padding:10px"></div>

<!-- Hidden quiz container (shows when test running) -->
<div id="quizRoot" style="display:none" class="quiz-wrap">
  <div id="questionBox" class="question-box">Loading...</div>
  <div id="optionsBox" class="options-box"></div>
  <div style="margin-top:12px; text-align:center;">
    <button class="button" id="prevBtn" style="display:none" onclick="prevQ()">â—€ Prev</button>
    <button class="button" id="nextBtn" style="display:none" onclick="nextQ()">Next â–¶</button>
  </div>
  <div id="progress" class="small" style="margin-top:12px"></div>
</div>

<!-- Audio (kept original sound links) -->
<audio id="soundStart" src="https://www.soundjay.com/misc/sounds/magic-chime-01.mp3" preload="auto"></audio>
<audio id="soundCorrect" src="https://www.soundjay.com/button/sounds/button-4.mp3" preload="auto"></audio>
<audio id="soundIncorrect" src="https://www.soundjay.com/button/sounds/button-16.mp3" preload="auto"></audio>
<audio id="soundFinish" src="https://www.soundjay.com/human/sounds/applause-3.mp3" preload="auto"></audio>

<script>
/*
  Rebuilt index.html for full 500-item test (Android friendly).
  - Loads questions from BACKEND_QUESTIONS_URL via GET ?getQuestions=1
  - Sends payment claims and verifies codes to BACKEND_PAYMENT_URL via POST
  - Keeps UI and flow similar to your original system
*/

// ==========================
// CONFIG â€” backend URLs
// ==========================
// This is your Apps Script Web App URL (questions backend and payment backend)
// Replace only if you later move to a different script
const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbyAahjib1U3F-L1HrRDItXBKImZXZNORT7z7hyKz373wq5Xg-xGParOZlO8J4B7hjXT/exec';

// Full test redirect after unlock (keeps your original)
const FULL_TEST_URL = 'https://gyoutrain-lab.github.io/nursing-prometric-test-allinone500/';

// ==========================
// App state
// ==========================
let questions = [];
let currentIndex = 0;
let user = null;

// ==========================
// Utilities
// ==========================
function el(id){ return document.getElementById(id); }
function playSound(id){ const a = el(id); if(a) a.play().catch(()=>{}); }

// ==========================
// Render login/register
// ==========================
document.getElementById('continueBtn').addEventListener('click', ()=> renderLogin());

function renderLogin(){
  const dash = el('dashboard');
  dash.innerHTML = `
    <div class="card">
      <h3>Login / Register</h3>
      <input type="text" id="inpName" placeholder="Full Name" />
      <input type="password" id="inpPassword" placeholder="Password" />
      <input type="text" id="inpTelegram" placeholder="Your Telegram Username or Chat ID" />
      <div style="text-align:right; margin-top:8px;">
        <button class="button" onclick="doRegister()">Register & Continue</button>
      </div>
    </div>
  `;
  // try to play start sound
  playSound('soundStart');
}

function doRegister(){
  const name = el('inpName').value.trim();
  const pw = el('inpPassword').value.trim();
  const tg = el('inpTelegram').value.trim();
  if(!name || !pw || !tg){ alert('Please fill all fields'); return; }
  const userId = 'u_' + Date.now();
  user = { name, password: pw, telegram: tg, userId };
  localStorage.setItem('npt_user', JSON.stringify(user));
  renderDashboard();
}

function renderDashboard(){
  const dash = el('dashboard');
  const name = (user && user.name) || (localStorage.getItem('npt_user') ? JSON.parse(localStorage.getItem('npt_user')).name : '');
  dash.innerHTML = `
    <div class="card">
      <h3>Welcome, ${name}</h3>
      <p class="small">Choose an option:</p>
      <div style="text-align:center">
        <button class="button" onclick="startPaymentFlow()">1. Continue Test</button>
        <button class="button" onclick="cancelToLanding()">2. Cancel</button>
      </div>
    </div>
  `;
}

// ==========================
// Payment flow -> notify admin
// ==========================
function startPaymentFlow(){
  // show payment instruction UI
  const dash = el('dashboard');
  dash.innerHTML = `
    <div class="card">
      <p>Step 1: Send IDR 50k to OVO: <strong>+6281901685253</strong></p>
      <div style="text-align:center"><button class="button" onclick="confirmPayment()">Payment Done</button></div>
    </div>
  `;
}

async function confirmPayment(){
  user = user || JSON.parse(localStorage.getItem('npt_user'));
  if(!user){ alert('Please register first'); renderLogin(); return; }

  // POST to backend: action paymentClaim
  const payload = { action:'paymentClaim', name:user.name, telegram:user.telegram, userId:user.userId };
  try{
    const res = await fetch(BACKEND_URL, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });
    const j = await res.json();
    if(j.ok){
      alert('Payment claim sent to admin. Admin will verify and generate the unlock code.');
      // show unlock code input for user to enter when admin gives code
      el('dashboard').innerHTML = `
        <div class="card">
          <p>Step 2: Waiting for admin verification...</p>
          <p>After admin verifies, they will give you a special unlock code. Enter it below:</p>
          <input type="text" id="unlockInput" placeholder="Enter Special Code" />
          <div style="text-align:right; margin-top:8px;">
            <button class="button" onclick="submitUnlock()">Unlock Test</button>
          </div>
        </div>
      `;
    } else {
      alert('Failed to send payment claim: ' + (j.error || 'unknown'));
    }
  } catch (err){
    console.error(err);
    alert('Network error while contacting backend');
  }
}

async function submitUnlock(){
  const code = el('unlockInput').value.trim();
  if(!code){ alert('Please enter code'); return; }
  user = user || JSON.parse(localStorage.getItem('npt_user'));
  const payload = { action:'verifyCode', userId:user.userId, code: code };
  try{
    const res = await fetch(BACKEND_URL, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });
    const j = await res.json();
    if(j.ok){
      playSound('soundFinish');
      alert('ðŸŽ‰ Code verified! Redirecting to full test...');
      // optional: clear stored unlock code or mark used
      window.location.href = FULL_TEST_URL;
    } else {
      playSound('soundIncorrect');
      alert('Invalid code. Please verify with admin.');
    }
  } catch (err){
    console.error(err);
    alert('Network error while verifying code');
  }
}

// ==========================
// Quiz engine (Android optimized UI)
// ==========================
async function loadQuestionsAndStart(){
  // show quiz area; hide dashboard
  el('dashboard').innerHTML = '';
  el('quizRoot').style.display = 'block';
  el('questionBox').innerText = 'Loading questions...';

  try{
    const res = await fetch(BACKEND_URL + '?getQuestions=1');
    if(!res.ok){ throw new Error('Network'); }
    const data = await res.json();
    if(!Array.isArray(data) || data.length === 0){
      el('questionBox').innerText = 'No questions found.';
      return;
    }
    questions = data;
    currentIndex = 0;
    renderQuestion();
    playSound('soundStart');
  } catch(e){
    console.error(e);
    el('questionBox').innerText = 'Failed to load questions. Check backend.';
  }
}

function renderQuestion(){
  if(currentIndex < 0) currentIndex = 0;
  if(currentIndex >= questions.length){
    finishQuiz();
    return;
  }

  const q = questions[currentIndex];
  // adapt question text (keeps subtitle reference if any)
  const qText = (q.no ? q.no + '. ' : '') + (q.question || '');
  el('questionBox').innerHTML = qText;

  const opts = q.options || [];
  const box = el('optionsBox');
  box.innerHTML = '';
  opts.forEach((opt, i) => {
    const btn = document.createElement('button');
    btn.className = 'option';
    btn.innerText = opt;
    btn.onclick = () => onSelect(i, q.correct);
    box.appendChild(btn);
  });

  // progress
  el('progress').innerText = `Question ${currentIndex + 1} / ${questions.length}`;
  // prev/next visibility
  el('prevBtn').style.display = currentIndex > 0 ? 'inline-block' : 'none';
  el('nextBtn').style.display = 'none';
}

function onSelect(selectedIndex, correctIndex){
  if(selectedIndex === correctIndex){
    playSound('soundCorrect');
  }else{
    playSound('soundIncorrect');
  }
  // show next button after selecting (optional: immediate next)
  el('nextBtn').style.display = 'inline-block';
  // advance automatically after a short delay
  setTimeout(()=>{ currentIndex++; renderQuestion(); }, 420);
}

function nextQ(){ currentIndex++; renderQuestion(); }
function prevQ(){ currentIndex--; renderQuestion(); }

function finishQuiz(){
  el('questionBox').innerHTML = 'âœ… Test completed. Thank you!';
  el('optionsBox').innerHTML = `<div class="small">You completed the demo. To access the full 500-item test, unlock following the payment steps.</div>`;
  el('progress').innerText = '';
  playSound('soundFinish');
}

// ==========================
// small helpers
// ==========================
function cancelToLanding(){ location.reload(); }

// On page load: if user already registered, render dashboard, otherwise show landing
window.addEventListener('load', ()=>{
  try{ const stored = localStorage.getItem('npt_user'); if(stored){ user = JSON.parse(stored); renderDashboard(); } }catch(e){}
});

</script>
</body>
</html>
