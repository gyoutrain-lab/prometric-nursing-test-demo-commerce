<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Nursing Prometric Test Portal</title>
<style>
body{
  font-family:Arial, sans-serif;
  text-align:center;
  background:#eef5f5;
  margin:0;
  padding:0;
}
img.landing-image {
  width:100%;
  max-height:50vh;
  object-fit:cover;
}
.header{padding:18px;background:#007b83;color:#fff;font-weight:bold}
.button {
  display:inline-block;padding:12px 20px;margin:10px;background:#007b83;color:white;border:none;border-radius:8px;cursor:pointer;text-decoration:none;
}
.input {padding:10px;margin:6px;width:80%;max-width:320px;font-size:16px;border-radius:6px;border:1px solid #ccc}
.container {max-width:520px;margin:18px auto;background:#fff;padding:18px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
.small{font-size:13px;color:#666}
.hidden{display:none}
.success{color:green}
.error{color:#b00020}
</style>
</head>
<body>

<img class="landing-image" src="https://raw.githubusercontent.com/gyoutrain-lab/prometric-nursing-test-demo/main/icon17%20(1).jpg" alt="Nursing Prometric Demo">
<div class="header">ðŸ©º Nursing Prometric Simulation Test</div>

<div class="container" id="landing">
  <p>Try the demo first or continue to the full 500-item test to master your skills!</p>
  <a class="button" href="https://gyoutrain-lab.github.io/prometric-nursing-test-demo/" target="_blank">ðŸ©º Open Demo Test</a>
  <button class="button" id="continueBtn">ðŸ”‘ Continue Full Test</button>
</div>

<!-- Registration -->
<div class="container hidden" id="registerBox">
  <h3>Login / Register</h3>
  <input id="name" class="input" placeholder="Full Name"><br>
  <input id="password" class="input" placeholder="Password" type="password"><br>
  <input id="telegram" class="input" placeholder="Your Telegram Username or Chat ID (e.g. @etkyogya)"><br>
  <button class="button" id="registerBtn">Register & Continue</button>
  <p class="small">We will save your User ID locally. Keep it to claim payment and unlock.</p>
  <div id="regMsg" class="small"></div>
</div>

<!-- Dashboard after register -->
<div class="container hidden" id="dashboardBox">
  <h3 id="welcomeName">Welcome</h3>
  <p>Choose an option:</p>
  <button class="button" id="continueTestBtn">1. Continue Test</button>
  <button class="button" id="cancelBtn">2. Cancel</button>
</div>

<!-- Payment -->
<div class="container hidden" id="paymentBox">
  <h3>Step 1: Payment</h3>
  <p class="small">Send IDR 50k to OVO +(62)81901685253</p>
  <button class="button" id="paymentDoneBtn">Payment Done</button>
</div>

<!-- Waiting for admin & unlock -->
<div class="container hidden" id="unlockBox">
  <h3>Step 2: Waiting for admin verification...</h3>
  <p class="small">Enter Special Code below when admin provides it via Telegram.</p>
  <input id="userCode" class="input" placeholder="Enter Special Code"><br>
  <button class="button" id="submitUnlockBtn">Unlock Test</button>
  <div id="unlockMsg" class="small"></div>
</div>

<script>
// ===== CONFIG =====
const BACKEND_URL = "https://script.google.com/macros/s/AKfycbwhI-82pMmOjJs8AAAefHLjSj2XJm2hXIgEzn7hr7tX_H3ui81tV0Gl7YhQ_wPrWVE5/exec";

// ===== UI ELEMENTS =====
const landing = document.getElementById('landing');
const registerBox = document.getElementById('registerBox');
const dashboardBox = document.getElementById('dashboardBox');
const paymentBox = document.getElementById('paymentBox');
const unlockBox = document.getElementById('unlockBox');

const continueBtn = document.getElementById('continueBtn');
const registerBtn = document.getElementById('registerBtn');
const continueTestBtn = document.getElementById('continueTestBtn');
const cancelBtn = document.getElementById('cancelBtn');
const paymentDoneBtn = document.getElementById('paymentDoneBtn');
const submitUnlockBtn = document.getElementById('submitUnlockBtn');

const regMsg = document.getElementById('regMsg');
const unlockMsg = document.getElementById('unlockMsg');
const welcomeName = document.getElementById('welcomeName');

// ===== EVENTS =====
continueBtn.addEventListener('click', () => {
  landing.classList.add('hidden');
  registerBox.classList.remove('hidden');
});

registerBtn.addEventListener('click', async () => {
  const name = document.getElementById('name').value.trim();
  const password = document.getElementById('password').value.trim();
  const telegram = document.getElementById('telegram').value.trim();
  if (!name || !password || !telegram) {
    regMsg.textContent = "Please fill all fields";
    regMsg.className='error';
    return;
  }

  const userId = "u_" + Date.now();
  localStorage.setItem('nursing_user', JSON.stringify({ name, password, telegram, userId }));
  regMsg.textContent = "Registering...";

  try {
    const res = await fetch(BACKEND_URL, {
      method: 'POST',
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action: "register", name, telegram, password, userId })
    });
    const j = await res.json();
    if (j.ok) {
      regMsg.textContent = j.message || "Registered";
      regMsg.className='success';
      setTimeout(showDashboard, 800);
    } else {
      regMsg.textContent = j.message || "Registration failed";
      regMsg.className='error';
    }
  } catch (e) {
    regMsg.textContent = "Network error: please check internet or backend URL.";
    regMsg.className='error';
  }
});

function showDashboard(){
  registerBox.classList.add('hidden');
  const u = JSON.parse(localStorage.getItem('nursing_user')||'{}');
  welcomeName.textContent = "Welcome, " + (u.name||'User');
  dashboardBox.classList.remove('hidden');
}

continueTestBtn.addEventListener('click', () => {
  dashboardBox.classList.add('hidden');
  paymentBox.classList.remove('hidden');
});

cancelBtn.addEventListener('click', () => {
  dashboardBox.classList.add('hidden');
  landing.classList.remove('hidden');
});

paymentDoneBtn.addEventListener('click', async () => {
  const u = JSON.parse(localStorage.getItem('nursing_user')||'{}');
  if (!u || !u.userId) { alert("User ID missing. Please register again."); return; }

  try {
    const res = await fetch(BACKEND_URL, {
      method: 'POST',
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action: "paymentClaim", userId: u.userId, name: u.name, telegram: u.telegram })
    });
    const j = await res.json();
    if (j.ok) {
      paymentBox.classList.add('hidden');
      unlockBox.classList.remove('hidden');
    } else {
      alert(j.message || "Failed to send payment claim");
    }
  } catch (e) {
    alert("Network error: please check internet or backend URL.");
  }
});

submitUnlockBtn.addEventListener('click', async () => {
  const code = document.getElementById('userCode').value.trim();
  const u = JSON.parse(localStorage.getItem('nursing_user')||'{}');
  if (!u || !u.userId) { unlockMsg.textContent = "Missing user. Re-register."; return; }
  if (!code) { unlockMsg.textContent = "Enter code"; return; }
  unlockMsg.textContent = "Verifying...";

  try {
    const res = await fetch(BACKEND_URL, {
      method: 'POST',
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action: "verifyCode", userId: u.userId, code })
    });
    const j = await res.json();
    if (j.ok) {
      unlockMsg.textContent = "ðŸŽ‰ Code verified! Redirecting...";
      setTimeout(()=>{ window.location.href = "https://gyoutrain-lab.github.io/nursing-prometric-test-allinone500/"; }, 1200);
    } else {
      unlockMsg.textContent = j.message || "Invalid code.";
    }
  } catch (e) {
    unlockMsg.textContent = "Network error: please check internet or backend URL.";
  }
});
</script>
</body>
</html>
