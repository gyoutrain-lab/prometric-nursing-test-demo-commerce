/*
Full Google Apps Script backend for Nursing Prometric Test Portal
Project: NursingPrometricBackend
Features included (defaults set):
- Google Sheet logging (Payments & Codes & Subscriptions)
- Unlock code expiration (30 minutes default)
- Multi-admin support (ADMIN_CHAT_IDS script property, comma separated)
- Subscription system (30-day subscriptions)
- Admin dashboard (simple HTML) protected by ADMIN_DASHBOARD_TOKEN

Important: After deploy, set Script Properties:
- BOT_TOKEN = your bot token
- ADMIN_CHAT_IDS = 7360795604      (comma separated list if multiple)
- WEB_APP_URL = https://script.google.com/macros/s/DEPLOY_ID/exec
- SHEET_ID = (ID of Google Sheet to log data)
- ADMIN_DASHBOARD_TOKEN = a secret token string (eg: supersecret123)
- CODE_EXPIRY_MINUTES = 30
- SUBSCRIPTION_DAYS = 30

Endpoints (POST JSON):
- action=paymentClaim  {name,telegram,userId}
- action=verifyCode    {userId,code}
- action=createSubscription {userId,name,telegram}
- GET ?action=generateCode&token=ADMIN_TOKEN  (admin clicks secure link from Telegram)
- GET ?admin=true&token=ADMIN_DASHBOARD_TOKEN  -> admin HTML dashboard

Security notes:
- BOT_TOKEN never exposed to front-end. Use Script Properties.
- Admin generation link uses one-time token stored server-side and removed after use.
*/

const PROP = {
  BOT_TOKEN: 'BOT_TOKEN',
  ADMIN_CHAT_IDS: 'ADMIN_CHAT_IDS',
  WEB_APP_URL: 'WEB_APP_URL',
  SHEET_ID: 'SHEET_ID',
  ADMIN_DASHBOARD_TOKEN: 'ADMIN_DASHBOARD_TOKEN',
  CODE_EXPIRY_MINUTES: 'CODE_EXPIRY_MINUTES',
  SUBSCRIPTION_DAYS: 'SUBSCRIPTION_DAYS'
};

function doGet(e){
  if (e.parameter && e.parameter.action === 'generateCode' && e.parameter.token) {
    return handleGenerateCode(e.parameter.token);
  }
  if (e.parameter && e.parameter.admin === 'true' && e.parameter.token) {
    return renderAdminDashboard(e.parameter.token);
  }
  return ContentService.createTextOutput('NursingPrometricBackend running.');
}

function doPost(e){
  const params = e.postData && e.postData.type === 'application/json' ? JSON.parse(e.postData.contents) : e.parameter;
  const action = params.action;
  if (action === 'paymentClaim') return paymentClaim(params);
  if (action === 'verifyCode') return verifyCode(params);
  if (action === 'createSubscription') return createSubscription(params);
  return ContentService.createTextOutput(JSON.stringify({ok:false, error:'unknown action'})).setMimeType(ContentService.MimeType.JSON);
}

// -- Payment claim: create pending token, send admin secure link, log to sheet
function paymentClaim(params){
  const name = params.name || 'Unknown';
  const telegram = params.telegram || '';
  const userId = params.userId || Utilities.getUuid();
  const timestamp = new Date().toISOString();

  const adminToken = Utilities.getUuid();
  const store = _getStore();
  store.pending = store.pending || {};
  store.pending[adminToken] = { userId, name, telegram, status: 'claimed', created: timestamp };
  _setStore(store);

  // log to sheet
  _appendSheetRow(['PAYMENT_CLAIM', timestamp, userId, name, telegram, adminToken, 'pending']);

  // admin link
  const webUrl = _getProp(PROP.WEB_APP_URL);
  if (!webUrl) return _json({ok:false, error:'WEB_APP_URL not set'});
  const link = `${webUrl}?action=generateCode&token=${adminToken}`;

  const message = `ðŸ’° Payment claim received\nName: ${name}\nTelegram: ${telegram}\n\nTo generate unlock code for this user, open this secure link (admin only):\n${link}`;
  const tg = _sendToAdmins(message);
  return _json({ok:true, adminToken, tg});
}

function handleGenerateCode(token){
  const store = _getStore();
  if (!store.pending || !store.pending[token]) return ContentService.createTextOutput('Invalid or expired token.');
  const rec = store.pending[token];
  const now = new Date();
  const code = String(Math.floor(100000 + Math.random() * 900000));
  const expiryMinutes = Number(_getProp(PROP.CODE_EXPIRY_MINUTES) || 30);
  const expiresAt = new Date(now.getTime() + expiryMinutes*60000).toISOString();

  // store code under codes keyed by userId
  store.codes = store.codes || {};
  store.codes[rec.userId] = { code: code, name: rec.name, telegram: rec.telegram, created: now.toISOString(), expiresAt: expiresAt };
  // remove pending token
  delete store.pending[token];
  _setStore(store);

  // log to sheet
  _appendSheetRow(['CODE_GENERATED', now.toISOString(), rec.userId, rec.name, rec.telegram, code, expiresAt]);

  // send to admins
  const message = `âœ… Unlock Code for ${rec.name} (${rec.telegram}): ${code}\nExpires at: ${expiresAt}\nPlease pass this code to the user.`;
  _sendToAdmins(message);

  // return a friendly HTML so admin can close
  return HtmlService.createHtmlOutput('<html><body><h3>Unlock code generated and sent to admin(s).</h3><p>You can close this tab.</p></body></html>');
}

function verifyCode(params){
  const userId = params.userId;
  const code = (params.code||'').trim();
  if(!userId||!code) return _json({ok:false,error:'missing params'});
  const store = _getStore();
  if (!store.codes || !store.codes[userId]) return _json({ok:false,error:'no code for user'});
  const rec = store.codes[userId];
  // check expiry
  const now = new Date();
  if (new Date(rec.expiresAt) < now) { delete store.codes[userId]; _setStore(store); _appendSheetRow(['CODE_EXPIRED', now.toISOString(), userId, rec.name, rec.telegram, rec.code]); return _json({ok:false,error:'code expired'}); }
  if (rec.code === code) {
    // success - consume code
    delete store.codes[userId];
    _setStore(store);
    _appendSheetRow(['CODE_VERIFIED', new Date().toISOString(), userId, rec.name, rec.telegram, code]);
    return _json({ok:true,message:'Code verified'});
  }
  _appendSheetRow(['CODE_FAILED', new Date().toISOString(), userId, rec.name, rec.telegram, code]);
  return _json({ok:false,error:'invalid code'});
}

function createSubscription(params){
  const userId = params.userId || Utilities.getUuid();
  const name = params.name || 'Unknown';
  const telegram = params.telegram || '';
  const days = Number(_getProp(PROP.SUBSCRIPTION_DAYS) || 30);
  const now = new Date();
  const expires = new Date(now.getTime() + days*24*60*60000).toISOString();

  const store = _getStore();
  store.subscriptions = store.subscriptions || {};
  store.subscriptions[userId] = { name, telegram, started: now.toISOString(), expiresAt: expires };
  _setStore(store);

  _appendSheetRow(['SUBSCRIPTION_CREATED', new Date().toISOString(), userId, name, telegram, expires]);
  return _json({ok:true,expiresAt:expires});
}

// --- Admin dashboard (simple) ---
function renderAdminDashboard(token){
  const adminToken = _getProp(PROP.ADMIN_DASHBOARD_TOKEN);
  if (!adminToken || token !== adminToken) return HtmlService.createHtmlOutput('Unauthorized');
  const html = `
    <html><body>
    <h2>NursingPrometric Admin Dashboard</h2>
    <p>This dashboard shows recent events and allows simple actions.</p>
    <p>NOTE: This is a basic view. Use the Google Sheet for full logs.</p>
    <button onclick="google.script.run.withSuccessHandler(()=>alert('Not implemented'))._dummy()">Refresh (placeholder)</button>
    </body></html>`;
  return HtmlService.createHtmlOutput(html);
}

function _dummy(){return}

// --- Helper functions ---
function _getStore(){
  const raw = PropertiesService.getScriptProperties().getProperty('STORE_V2');
  if (!raw) return {};
  try { return JSON.parse(raw); } catch(e) { return {}; }
}
function _setStore(obj){ PropertiesService.getScriptProperties().setProperty('STORE_V2', JSON.stringify(obj)); }

function _getProp(key){ return PropertiesService.getScriptProperties().getProperty(key); }

function _sendToAdmins(text){
  const token = _getProp(PROP.BOT_TOKEN);
  const adminCsv = _getProp(PROP.ADMIN_CHAT_IDS) || '';
  const admins = adminCsv.split(',').map(s=>s.trim()).filter(Boolean);
  if (!token || admins.length===0) return {ok:false,error:'bot token or admin ids not set'};
  const url = `https://api.telegram.org/bot${token}/sendMessage`;
  const results = [];
  admins.forEach(chatId => {
    const payload = { chat_id: chatId, text: text, disable_web_page_preview: true };
    const opts = { method:'post', contentType:'application/json', payload: JSON.stringify(payload), muteHttpExceptions:true };
    const resp = UrlFetchApp.fetch(url, opts);
    try{ results.push(JSON.parse(resp.getContentText())); } catch(e){ results.push({ok:false,resp:resp.getContentText()}); }
  });
  return results;
}

function _appendSheetRow(row){
  const sheetId = _getProp(PROP.SHEET_ID);
  if (!sheetId) return;
  try{
    const ss = SpreadsheetApp.openById(sheetId);
    const sh = ss.getSheetByName('Log') || ss.insertSheet('Log');
    sh.appendRow(row);
  } catch(e){
    console.error('Sheet append failed', e);
  }
}

function _json(obj){ return ContentService.createTextOutput(JSON.stringify(obj)).setMimeType(ContentService.MimeType.JSON); }

// --- Setup helper (run once manually to set properties in code if desired) ---
function setupDefaults(){
  // Example to set properties programmatically (alternatively set via Project Properties UI)
  // PropertiesService.getScriptProperties().setProperty('BOT_TOKEN', '8298413377:...');
  // PropertiesService.getScriptProperties().setProperty('ADMIN_CHAT_IDS','7360795604');
  // PropertiesService.getScriptProperties().setProperty('CODE_EXPIRY_MINUTES','30');
  // PropertiesService.getScriptProperties().setProperty('SUBSCRIPTION_DAYS','30');
}
